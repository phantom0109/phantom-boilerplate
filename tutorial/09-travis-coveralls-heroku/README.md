# 09 - Travis, Coveralls, and Heroku

**This is the last chapter of the tutorial. The final code is available in the [JS-Stack-Boilerplate repository](https://github.com/verekia/js-stack-boilerplate).**

## Travis

> Blah

- Create a `.travis.yml` file containing:

```yaml
language: node_js
node_js: node
script: yarn test && yarn prod:build
```

## Coveralls

> Blah

If your project is open-source on Github and compatible with Coveralls' supported Continuous Integration services, the only thing you need to do is to pipe the coverage file generated by Jest to the `coveralls` binary.

- Run `yarn add coveralls`

- Edit your `.travis.yml`'s `script` instruction like so:

```yaml
script: yarn test && yarn prod:build && cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js
```

## Badges

You can use [shields.io](http://shields.io/) to homogenize or customize your badges.

- Create or edit your `README.md` like so:

```md
[![Build Status](https://img.shields.io/travis/GITHUB-USERNAME/GITHUB-REPO.svg?style=flat-square)](https://travis-ci.org/verekia/js-stack-boilerplate)
[![Coverage Status](https://img.shields.io/coveralls/GITHUB-USERNAME/GITHUB-REPO.svg?style=flat-square)](https://coveralls.io/github/verekia/js-stack-boilerplate?branch=master)
```

## Heroku

> Blah

If that's not the done yet, install the [Heroku CLI](https://devcenter.heroku.com/articles/getting-started-with-nodejs), log in, and go to your [Heroku Dashboard](https://dashboard.heroku.com/). Create 2 apps, one called `your-project-prod` and one called `your-project-staging` for instance. Create a Pipeline, allow access to Github, add both apps to the pipeline, and enable Review Apps.

- Run `yarn remove pm2`

- Create a `Procfile` file containing:

```Procfile
web: node lib/server
```

- Create a `.env` file containing:

```.env
NODE_ENV='production'
PORT='8000'
```

That's in this file that you should put your local-only variables and secret variables.

- Add `/.env` to your `.gitignore`

Since we are not going to use PM2 anymore, we'll use `heroku local` to run our environment

- Edit your `package.json` file to replace the `prod:start` script, remove `prod:stop`, and add a `heroku-postbuild` one:

```json
"scripts": {
  "start": "yarn dev:start",
  "dev:start": "nodemon -e js,jsx --ignore lib --ignore dist --exec babel-node src/server",
  "dev:wds": "webpack-dev-server --progress",
  "prod:build": "rimraf lib dist && babel src -d lib --ignore test.js && cross-env NODE_ENV=production webpack -p --progress",
  "prod:start": "heroku local",
  "lint": "eslint src webpack.config.babel.js --ext .js,.jsx",
  "test": "yarn lint && flow && jest --coverage",
  "heroku-postbuild": "yarn prod:build",
  "precommit": "yarn test",
  "prepush": "yarn test && yarn prod:build"
},
```

`heroku-postbuild` is a task that will be run everytime you deploy new code to the Heroku app.

We also got rid of the `prod:stop` task entirely, since `heroku local` is a hanging process that we can kill with Ctrl+C, unlike `pm2 start`.

You will also probably want to specify a specific version of Node or Yarn for Heroku to use.

- Add this to your `package.json`:

```json
"engines": {
  "node": "7.x",
  "yarn": "0.20.3"
},
```

- Create a `app.json` file containing:

```json
{
  "name": "your-project",
  "scripts": {},
  "env": {
    "NPM_CONFIG_PRODUCTION": "false"
  },
  "formation": {},
  "addons": [],
  "buildpacks": []
}
```

I've had issues with Yarn on Heroku not installing the `devDependencies`, even with the Yarn version that was supposed to address this problem. I'm sure this will be resolved soon, but in the meantime, use the `NPM_CONFIG_PRODUCTION` env variable, set to `false`, to make sure Yarn installs everything.

You should now be all set to use Heroku Pipeline deployments. Open a Github Pull Request to instantiate a Review App, check your changes, merge with `master`, test your auto-deployed changes on `your-project-staging`, and finally promote staging to production.

**This is the last chapter of the tutorial. The final code is available in the [JS-Stack-Boilerplate repository](https://github.com/verekia/js-stack-boilerplate).**

Back to the [previous section](/tutorial/08-bootstrap-jss) or the [table of contents](https://github.com/verekia/js-stack-from-scratch#table-of-contents).
